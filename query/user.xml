<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="user">
    <select id="selectUserId">
        SELECT
            user_no,
            user_id,
            user_password,
            created_at,
            updated_at,
            deleted_at,
            user_status
        FROM tb_user
        where user_id = #{user_id}
    </select>

    <select id="selectUserIdName">
        SELECT
            tu.user_id,
            tui.user_name
        from tb_user tu
                 inner join tb_user_info tui
            on tu.user_no = tui.user_no
        where tu.user_id = #{user_id}
    </select>

    <select id="selectUserNo">
        SELECT
        user_no,
        user_id,
        user_password,
        created_at,
        updated_at,
        deleted_at,
        user_status
        FROM tb_user
        where user_no = #{user_no}
    </select>

    <select id="selectUserCount">
        SELECT
            count(1) count
        FROM tb_user
        where user_id = #{user_id}
    </select>

    <insert id="insertTbUser">
        insert into tb_user (
            user_id,
            user_password,
            user_status
        )
        values (
            #{user_id},
            #{user_password},
            #{user_status}
        )
    </insert>

    <insert id="insertTbUserInfo">
        insert into tb_user_info
        (
             user_no,
             user_terms_agree,
             user_address,
             user_detail_address,
             mobile_phone,
             user_email,
             user_name,
             user_birth_day
        )
        values (
            #{user_no},
            #{user_terms_agree},
            #{user_address},
            #{user_detail_address},
            #{mobile_phone},
            #{user_email},
            #{user_name},
            #{user_birth_day}
        )
    </insert>

    <insert id="insertUserRecommend">
        insert into tb_user_recommend
        (
            user_no,
            recommend_user_no
        )
        values (
            #{user_no},
            #{recommend_user_no}
        )
    </insert>

    <select id="selectUserInfo">
        select
            tbs.user_id,
            tbs.user_password,
            tbs.user_status,
            tbi.user_name,
            tbi.mobile_phone,
            tbi.user_birth_day,
            tua.bank_name,
            tua.bank_account,
            tua.bank_holder,
            tbi.user_name,
            (
                select tbu2.user_id
                from tb_user tbu2
                where tbu2.user_no = tur.recommend_user_no
            ) as recommend_user_id
        from tb_user tbs
            inner join tb_user_info tbi
                on tbs.user_no = tbi.user_no
            left join tb_user_account tua
                on tbi.user_no = tbs.user_no
            left join tb_user_recommend tur
                on tbs.user_no = tur.user_no
        where tbs.user_id = #{user_id}
    </select>

    <update id="updateUserPassword">
        update tb_user set user_password = #{user_password} where user_id = #{user_id}
    </update>

    <insert id="insertUserAccount">
        insert into tb_user_account (
            user_no,
            bank_name,
            bank_account,
            bank_holder
        )
        values (
            #{user_no},
            #{bank_name},
            #{bank_account},
            #{bank_holder}
        )
    </insert>

    <update id="updateUserAccount">
        update created_at
        set
            bank_name = #{bank_name},
            bank_account = #{bank_account},
            bank_holder = # {bank_holder},
            updated_at = current_timestamp()
        where user_no = #{user_no};
    </update>

</mapper>
